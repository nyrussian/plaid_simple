<!-- index.html â€“ Links a sample bank account and renders balance information associated with the account. -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Credit Card Info</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .header { font-size: 24px; margin-bottom: 20px; }
    button { padding: 5px 10px; margin-top: 10px; }
</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script>
      (async ($) => {
        // Grab a Link token to initialize Link
        const createLinkToken = async () => {
          const res = await fetch("/api/create_link_token");
          const data = await res.json();
          const linkToken = data.link_token;
          localStorage.setItem("link_token", linkToken);
          return linkToken;
        };

        // Initialize Link
        const handler = Plaid.create({
          token: await createLinkToken(),
          onSuccess: async (publicToken, metadata) => {
            await fetch("/api/exchange_public_token", {
              method: "POST",
              body: JSON.stringify({ public_token: publicToken }),
              headers: {
                "Content-Type": "application/json",
              },
            });
            await getProducts();
          },
          onEvent: (eventName, metadata) => {
            console.log("Event:", eventName);
            console.log("Metadata:", metadata);
          },
          onExit: (error, metadata) => {
            console.log(error, metadata);
          },
        });

        // Start Link when button is clicked
        const linkAccountButton = document.getElementById("link-account");
        linkAccountButton.addEventListener("click", (event) => {
          handler.open();
        });
      })(jQuery);

      // Retrieves balance and liability information
      const getProducts = async function () {
        const response = await fetch("/api/balance", {
          method: "GET",
        });
        
        const data = await response.json();
        const liabilities_response = await fetch("/api/liabilities", {
          method: "GET",
        });
        const liabilities_data = await liabilities_response.json();

        const combined_data = {
          ...data,
          liabilities: liabilities_data,
        };

        //Render response data
        const pre = document.getElementById("response");
        pre.textContent = JSON.stringify(combined_data, null, 2);
        pre.style.background = "#F6F6F6";
      };


      // Check whether account is connected
      const getStatus = async function () {
        const account = await fetch("/api/is_account_connected");
        const connected = await account.json();
        if (connected.status == true) {
          getProducts();
        }
      };

      getStatus();
    </script>
  </head>
  <body>
    <!-- <button
      type="button"
      id="link-account"
      class="btn btn-primary btn-dark btn-lg"
      style="
        border: 1px solid black;
        border-radius: 5px;
        background: black;
        height: 48px;
        width: 155px;
        margin-top: 5; 
        margin-left: 10;
        color: white;
        font-size: 18px;
      "
    >
      <strong>Link account</strong>
    </button> -->
    
    <h1 class="header">Credit Card Info</h1>
<button onclick="addTestRow()">Add Test Row</button>
<button type="button"id="link-account"><strong>Link account</strong></button>
<button type="button"id="fetch_accounts">Fetch Accounts</button>
<table id="infoTable">
    <thead>
        <tr>
            <th>id</th>
            <th>user </th>
            <th>Account Name</th>
            <th>Account Number</th>
            <th>Total Balance</th>
            <th>Credit Limit</th>
            <th>Interest Rate</th>
            <th>Last Payment Date</th>
            <th>Last Payment Amount</th>
            <th>Next Payment Due</th>
            <th>due date</th>
            <th>Pay Date</th>
            <th>Statement Balance</th>
            <th>Account type</th>
            <th>Buisness account?</th>

            <th>action</th>
           
        </tr>
    </thead>
    <tbody>
        <!-- Rows will be added here by JavaScript -->
    </tbody>
    <tfoot>
        <tr>
            <td colspan="9">Total</td>
            <td id="totalAmount"></td>
        </tr>
    </tfoot>
</table>


<script>
    function addTestRow() {
        // Function to add an account
        const table = document.getElementById('infoTable').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow(table.rows.length);

        for (let i = 0; i < 9; i++) {
            let newCell = newRow.insertCell(i);
            newCell.innerHTML = 'New data'; // Placeholder, replace with actual data
        }
        
        let refreshCell = newRow.insertCell(8);
        refreshCell.innerHTML = '<button onclick="refreshRow(this)">Refresh</button> <button onclick="deleteRow(this)">Delete</button>';
    }
//update table from database
function updateTable(accounts) {
    const tableBody = document.getElementById('infoTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ''; // Clear existing table rows

    accounts.forEach(account => {
        const row = tableBody.insertRow();
        const id = row.insertCell(0);
        const user = row.insertCell(1);
        const account_name = row.insertCell(2);
        const account_number = row.insertCell(3);
        const total_bal = row.insertCell(4);
        const credit_limit = row.insertCell(5);
        const interest_rate = row.insertCell(6);
        const last_payment_date = row.insertCell(7);
        const last_payment_amount = row.insertCell(8);
        const next_payment_due = row.insertCell(9);
        const due_date = row.insertCell(10);
        const pay_date = row.insertCell(11);
        const statement_balance = row.insertCell(12);
        const account_type = row.insertCell(13);
        const buisness_account = row.insertCell(14);
        const action  = row.insertCell(15);

        id.textContent = account.id;
        user.textContent = account.user_id;
        account_name.textContent = account.account_name;
        account_number.textContent = account.account_number;
        total_bal.textContent = account.total_bal;
        credit_limit.textContent = account.credit_limit;
        interest_rate.textContent = account.rate;
        last_payment_date.textContent = account.last_payment_date;
        last_payment_amount.textContent = account.last_payment_amount;
        next_payment_due.textContent = account.due_date;
        due_date.textContent = account.due_date;
        pay_date.textContent = account.pay_date;
        statement_balance.textContent = account.statement_bal;
        account_type.textContent = account.type;
        buisness_account.textContent = account.buisness; 
        action.innerHTML = '<button onclick="refreshRow(this)">Refresh</button> <button onclick="deleteRow(this)">Delete</button>';


        
    });
}




    function refreshRow(button) {
        // Function to refresh a row
        alert("Refresh row " + button.parentNode.parentNode.rowIndex);
    }

    function deleteRow(button) {
        // Function to delete a row
        let row = button.parentNode.parentNode;
        let table = row.parentNode.parentNode;
        table.deleteRow(row.rowIndex);
    }
    // async function fetchFromDb() {
    //   const response = await fetch("/api/accountData", {
    //     method: "GET",
    //   });
    //   const data = await response.json();
    //   return data;
    // }

    const fetchAccountsButton = document.getElementById("fetch_accounts");
    fetchAccountsButton.addEventListener("click", fetchAccounts);
    
    async function fetchAccounts() {
      try {
        const response = await fetch('/api/accountData/');
        const data = await response.json();
        
      updateTable(data);
        // const dbDataElement = document.getElementById("db_data");
        // dbDataElement.innerHTML = JSON.stringify(data);
      } catch (error) {
        console.error(error);
      }
    }
   

  </script>
    <pre
      id="response"
      style="
        top: 60;
        margin-left: 10;
        bottom: 0;
        overflow-y: scroll;
        overflow-x: hidden;
        font-size: 14px;
      "
    ></pre>
    <div id ="db_data"></div>

  </body>
</html>
